<!DOCTYPE html>
<html lang="en">

<head>
  <title>Famicom Emulator</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
  <style type="text/css">
    #box {text-align: center; padding-top: 130px;}
    #screen {transform: scale(2);}
  </style>
  <script src="wasm_exec.js"></script>
  <script>
let goMemArr, fbOffset, canvasCtx, canvasData

window.copyFromJsArr = (arr, ptr) => {
  goMemArr.set(arr, ptr)
}
window.setFrameBuffer = (ptr) => {
  fbOffset = ptr
}
window.updateScreen = () => {
  canvasData.data.set(goMemArr.slice(fbOffset, fbOffset + 261120))
  canvasCtx.putImageData(canvasData, 0, 0)
}
window.goFuncs = {}

const go = new Go()
WebAssembly.instantiateStreaming(fetch("go_main.wasm"), go.importObject).
  then(res => {
    goMemArr = new Uint8Array(res.instance.exports.mem.buffer)
    go.run(res.instance)
  })

let onEmuStart = () => {
  document.onkeydown = event => {
    window.goFuncs.onKey(event.code, true)
  }
  document.onkeyup = event => {
    window.goFuncs.onKey(event.code, false)
  }
}

window.onload = () => {
  let fileElem = document.getElementById("file-input")
  fileElem.addEventListener("change", event => {
    let reader = new FileReader()
    reader.onload = event => {
      let fileArr = new Uint8Array(event.target.result)
      let ret = window.goFuncs.start(fileArr, fileArr.length)
      if (ret === true) {
        ret = "running."
        fileElem.hidden = true
        onEmuStart()
      }
      document.getElementById("msg").innerText = ret
    }
    if (event.target.files.length > 0) {
      reader.readAsArrayBuffer(event.target.files[0])
    }
  })
  canvasCtx = document.getElementById("screen").getContext("2d", {alpha: false})
  canvasData = canvasCtx.createImageData(272, 240)
}
  </script>
</head>

<body>
  <input id="file-input" type="file" />
  <span id="msg"></span>
  <br />
  <div id="box">
    <canvas id="screen" width="272" height="240"></canvas>
  </div>
</body>

</html>
